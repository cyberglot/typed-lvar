\documentclass[main.tex]{subfiles}
\begin{document}

\section{Typed LVars: deterministic parallelism}
\usingnamespace{lvar}

\subsection{The \typedlambdalvar calculus}

\todo{%
  Describe \typedlambdalvar as a typing discipline for \lambdalvar, and explain
  that it will allow us to rid ourselves of the error reductions and the
  $\tm{\error}$ configuration.}

\paragraph*{Types}
Types ($\ty{T}$, $\ty{U}$),  and typing environments ($\ty{\Gamma}$) are defined by the following grammar:
\[
\begin{array}{lrll}
  \ty{T}, \ty{U}
  & \coloneqq & \ty{\tyunit}        & \text{units} \\
  & \sep      & \ty{\typrod{T}{U}}  & \text{pairs} \\
  & \sep      & \ty{\tyfun{T}{U}}   & \text{functions}\\
  & \sep      & \ty{\tyD{d}}        & \text{domain values }{\sqsubseteq d}\\
  & \sep      & \ty{\tyL{\frz}{d}}  & \text{location with values }{\sqsubseteq d}\\
  & \sep      & \ty{\tyJ}           & \text{thresholds}
  \\
  \ty{\Gamma}
  & \coloneqq & \ty{\emptyenv}
    \sep        \ty{\ty{\Gamma},\tmty{x}{T}}
                                    & \text{typing environments}
  \\
  \ty{\Sigma}
  & \coloneqq & \ty{\emptyenv}
    \sep        \ty{\ty{\Sigma},\tmty{l}{\tyL{d}{\frz}}}
                                    & \text{store typing environments}
\end{array}
\]
Types $\ty{\tyunit}$, $\ty{\typrod{T}{U}}$, and $\ty{\tyfun{T}{U}}$ are the standard unit, pair, and function types.
The type $\tyD{d}$ types domain values with the upper bound $d$.
The type $\tyL{\frz}{d}$ types locations which store values of type $\tyD{d}$.
Thresholds occur on both the type- and term-level. Each threshold type $\tyJ$ has only one inhabitant, which is the same threshold $\tmJ$ on the term-level.

We extend $\sqcup$ and $\sqsubseteq$ to store typing environments.
The operation $\sqcup$ takes two store typing environments with identical structure \emph{up to domain bounds}, and returns the store typing environment with the pointwise maximum of each domain bound. Notably, status bits are unaffected by $\sqcup$.
The relation $\sqsubseteq$ takes two store typing environments with identical structure up to domain bounds and status bits, and checks if each domain bound or status bit in the first argument is smaller than the corresponding domain bound or status bit in the second argument.
\begin{mathpar}
  \setlength{\arraycolsep}{2pt}
  \begin{array}{lclcl}
    \ty{\emptyenv}
    & \sqcup & \ty{\emptyenv}
    & = & \ty{\emptyenv}
    \\
    \ty{\Sigma'},\tmty{l}{\tyL{\frz}{d'}}
    & \sqcup & \ty{\Sigma'},\tmty{l}{\tyL{\frz}{d}}
    & = & \ty{\Sigma}\sqcup\ty{\Sigma'},\tmty{l}{\tyL{\frz}{{d}\sqcup{d'}}}
    \\
    \\
    \ty{\emptyenv}
    & \sqsubseteq & \ty{\emptyenv}
    \\
    \ty{\Sigma'},\tmty{l}{\tyL{\frz'}{d'}}
    & \sqsubseteq & \ty{\Sigma},\tmty{l}{\tyL{\frz}{d}}
    \\
    & \text{if} & \multicolumn{3}{r}{
                  \ty{\Sigma'}\sqsubseteq\ty{\Sigma},
                  \ty{\frz'}\sqsubseteq\ty{\frz},\text{ and }
                  \ty{d'}\sqsubseteq\ty{d}}
  \end{array}
\end{mathpar}

\paragraph{Typing rules}%
\label{sec:lvar-typing}
\input{fig/typing}
See~\cref{fig:typing,fig:typing-configurations}.

\subsection{Metatheory}

\begin{lemma}[Substitution]
  \label{lem:substitution}
  If $\seq{\ty{\Gamma},\tmty{x}{T}}{\ty{\Sigma}}{M}{U}$ and $\seq{\ty{\Gamma}}{\ty{\Sigma'}}{V}{T}$, then $\seq{\ty{\Gamma}}{\ty{\Sigma}\sqcup\ty{\Sigma'}}{\subst{M}{V}{x}}{U}$.
\end{lemma}
\begin{lemma}[Subject reduction, $\redc$]
  \label{lem:subject-reduction}
  If $\seq{\ty{\Gamma}}{\ty{\Sigma}}{C}{T}$ and $\tm{C}\redc\tm{C'}$, then $\seq{\ty{\Gamma}}{\ty{\Sigma},\ty{\Sigma'}}{C'}{T}$ for some $\ty{\Sigma'}$.
\end{lemma}
\input{fig/subject-reduction-redc}

\begin{theorem}[Subject reduction, $\rede$]
  \label{thm:subject-reduction}
  If $\seq{\ty{\Gamma}}{\ty{\Sigma}}{C}{T}$ and $\tm{C}\redc\tm{C'}$, then $\seq{\ty{\Gamma}}{\ty{\Sigma},\ty{\Sigma'}}{C'}{T}$ for some $\ty{\Sigma'}$.
\end{theorem}

\todo{%
  I'm not sure whether proving error-freedom separately is a good idea. If we
  \emph{keep} the error configuration and the error reductions in the typed
  calculus, then we'd have to prove this, and we could use this as a motivation
  for removing them. However, if we remove them to begin with, then we'd
  essentially have to prove the same thing while proving progress, since the
  terms that would originally have errored now become stuck.}
\begin{lemma}[Error-freedom, $\redc$]
  \label{lem:error-free}
  If $\seq{\ty{\Gamma}}{\ty{\Sigma}}{C}{T}$, then $\tm{C}\centernot\redc\tm{\error}$.
\end{lemma}
\begin{proof}
  By inversion on the structure of $\tm{C}\redc\tm{\error}$.
  \todo{%
    The core of what was reflection:\\
    Examine all possible reduction rules which could lead to $\tm{\error}$, and
    show that if those rules were to be applied, $\tm{C}$ would be ill-typed.}
\end{proof}
\begin{theorem}[Error-freedom, $\rede$]
  \label{thm:error-free}
  If $\seq{\ty{\Gamma}}{\ty{\Sigma}}{C}{T}$, then $\tm{C}\centernot\rede\tm{\error}$.
\end{theorem}
\begin{proof}
  By inversion on the structure of $\tm{C}\rede\tm{\error}$.
  \todo{%
    Essentially, you wanna discard the evaluation context, and invoke the
    previous lemma on the resulting reduction.}
\end{proof}

\begin{theorem}[Progress, $\rede$]
  \label{thm:progress}
  If $\seq{\ty{\Gamma}}{\ty{\Sigma}}{C}{T}$, then:
  \begin{itemize}
  \item $\tm{C}\rede\tm{C'}$ for some $\tm{C'}$; or
  \item $\tm{C}=\tm{\config{V}{S}}$ for some $\tm{V}$ and $\tm{S}$.
  \end{itemize}
\end{theorem}
\begin{proof}
  By induction on the structure of $\seq{\ty{\Gamma}}{\ty{\Sigma}}{C}{T}$.
  \todo{%
    Examine each possible typing rule which could result in $\tm{C}$ being
    well-typed, and show that for each of them, either $\tm{C}$ can reduce, or
    it is a value.}
  \todo{%
    I~think it's easier to prove this \emph{directly} on $\rede$, since
    otherwise you'd have to give a statement of progress with a third case,
    which is that $\tm{C}$ is of the form $\tm{\config{\plug{E}{M}}{S}}$, where
    $\tm{\config{M}{S}}$ can reduce.}
  \todo{%
    This proof \emph{contains} the core of what used to be reflection, since we
    remove the error configuration and hence any term which would originally
    error would now be stuck, violating progress.}
\end{proof}

\begin{corollary}[Generalised Independence]
\end{corollary}

\begin{corollary}[Determinism, $\rede$]
\end{corollary}


\end{document}

%%% Local Variables:
%%% TeX-master: "main"
%%% End:
